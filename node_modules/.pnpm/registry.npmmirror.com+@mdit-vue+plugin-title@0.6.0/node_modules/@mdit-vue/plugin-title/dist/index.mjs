import { resolveTitleFromToken } from '@mdit-vue/shared';

const titlePlugin = (md) => {
  let title;
  md.core.ruler.push("resolveTitle", (state) => {
    const tokenIdx = state.tokens.findIndex((token) => token.tag === "h1");
    if (tokenIdx > -1) {
      title = resolveTitleFromToken(state.tokens[tokenIdx + 1], {
        shouldAllowHtml: false,
        shouldEscapeText: false
      });
    } else {
      title = "";
    }
    return true;
  });
  const render = md.render.bind(md);
  md.render = (src, env = {}) => {
    const result = render(src, env);
    env.title = title;
    return result;
  };
};

export { titlePlugin };
