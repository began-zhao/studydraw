"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@vuepress/utils"),e=require("@vuepress/shared"),i=require("vuepress-shared"),a=require("path"),n=require("xml-js");const r=new i.Logger("vuepress-plugin-feed2"),s=(t,e)=>t&&t instanceof Date?e&&e instanceof Date?e.getTime()-t.getTime():-1:1,o=(t,e=[])=>t.replace(/ class=".*?"/gu,"").replace(/ v-pre/gu,"").replace(/<a href="#.*?">.*?<\/a>/gu,"").replace(/(<!--.*?--!?>)|(<!--[\S\s]+?--!?>)|(<!--[\S\s]*?$)/gu,"").replace(/<ExternalLinkIcon ?\/>/gu,"").replace(/<RouterLink to="(.*?)">(.*?)<\/RouterLink>/gu,'<a href="$1">$2</a>').replace(/<(?:a|div|span)[^>]*?\/>/gu,"").replace(new RegExp(`<(${e.join("|")})[^>]*?(?:>*?<\\/\\1>|\\/>)`,"gu"),"<i>Content not supported</i>").replace(/<math[\s\S]*?\/math>/gu,"<i>Content not supported</i>"),p=(t,i="",a="")=>`${e.isLinkHttp(t)?e.removeEndingSlash(t):`https://${e.removeEndingSlash(t)}`}${i}${e.removeLeadingSlash(a)}`,u=(t="")=>`image/${"jpg"===t?"jpeg":"svg"===t?"svg+xml":"jpeg"===t||"png"===t||"bmp"===t||"gif"===t||"webp"===t?t:""}`,l=t=>{t.atom=t.output?.atom?.enable??!0,t.json=t.output?.json?.enable??!0,t.rss=t.output?.rss?.enable??!0,t.atomOutputFilename=t.output?.atom?.path??"atom.xml",t.jsonOutputFilename=t.output?.json?.path??"feed.json",t.jsonOutputFilename=t.output?.rss?.path??"rss.xml",((t,e,i="",a="")=>{e in t&&(r.error(`"${e}" is removed${a?`, please use ${a} instead.`:" and no longer supported"}${i?`\n${i}`:""}`),a||delete t[e])})(t,"output")},c=(t,e,a="")=>{const{base:n}=t.options,{title:r,description:s,lang:o,locales:u}=t.siteData,{hostname:l,icon:c,image:h}=e,d=e.channel?.author?.name,g={title:u[a]?.title||r||u["/"]?.title||"",link:p(l,n,a),description:u[a]?.description||s||u["/"]?.description||"",language:u[a]?.lang||o,copyright:d?`Copyright by ${d}`:"",pubDate:new Date,lastUpdated:new Date,...c?{icon:c}:{},...h?{image:h}:{},...d?{author:{name:d}}:{}};return i.deepAssign(g,e.channel||{})},h=(t,i="/")=>({atomOutputFilename:`${e.removeLeadingSlash(i)}${t.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${e.removeLeadingSlash(i)}${t.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${e.removeLeadingSlash(i)}${t.rssOutputFilename||"rss.xml"}`}),d=({options:{base:t}},e)=>{const{hostname:i}=e,{atomOutputFilename:a,jsonOutputFilename:n,rssOutputFilename:r}=h(e);return{atom:p(i,t,a),json:p(i,t,n),rss:p(i,t,r)}},g=t=>{const{name:e="Unknown",email:a,url:n}=t;return{name:e,...a?{email:a}:{},...n?{uri:i.encodeXML(n)}:{}}},m=t=>{const e=t.guid||i.encodeXML(t.link);return{...i.isUrl(e)?{}:{_attributes:{isPermaLink:!1}},_text:e}};class f{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=t=>{this.items.push(t)},this.addCategory=t=>{this.categories.add(t)},this.addContributor=t=>{const e=t.email||t.name;e&&!this._contributorKeys.has(e)&&(this._contributorKeys.add(e),this.contributors.push(t))},this.atom=()=>(t=>{const{channel:e,links:a}=t.options,r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...e.language?{"xml:lang":e.language}:{}},id:e.link,title:e.title,...e.description?{subtitle:e.description}:{},...e.author?{author:g(e.author)}:{},updated:e.lastUpdated?e.lastUpdated.toISOString():(new Date).toISOString(),generator:"vuepress-plugin-feed2",link:[{_attributes:{rel:"self",href:i.encodeXML(a.atom)}}]}};return e.link&&r.feed.link.push({_attributes:{rel:"alternate",href:i.encodeXML(e.link)}}),e.hub&&r.feed.link.push({_attributes:{rel:"hub",href:i.encodeXML(e.hub)}}),e.image&&(r.feed.logo=e.image),e.icon&&(r.feed.icon=e.icon),e.copyright&&(r.feed.rights=e.copyright),r.feed.category=Array.from(t.categories).map((t=>({_attributes:{term:t}}))),r.feed.contributor=Array.from(t.contributors).filter((t=>t.name)).map((t=>g(t))),r.feed.entry=t.items.map((t=>{const e={title:{_attributes:{type:"html"},_text:i.encodeXML(t.title)},id:i.encodeXML(t.guid||t.link),link:{_attributes:{href:i.encodeXML(t.link)}},updated:t.lastUpdated.toISOString()};return t.description&&(e.summary=t.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:i.encodeCDATA(t.description.substring(5))}:{_attributes:{type:"html"},_text:t.description}),t.content&&(e.content={_attributes:{type:"html"},_cdata:i.encodeCDATA(t.content)}),t.author&&(e.author=t.author.filter((t=>t.name)).map((t=>g(t)))),t.category&&(e.category=t.category.map((t=>(t=>{const{name:e,scheme:i=""}=t;return{_attributes:{term:e,scheme:i}}})(t)))),t.contributor&&(e.contributor=t.contributor.map((t=>g(t)))),t.pubDate&&(e.published=t.pubDate.toISOString()),t.copyright&&(e.rights=t.copyright),e})),n.js2xml(r,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.rss=()=>(t=>{const{links:e,channel:a}=t.options;let r=!1;const s={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:e.rss,rel:"self",type:"application/rss+xml"}},title:{_text:a.title},link:{_text:i.encodeXML(a.link)},description:{_text:a.description},language:{_text:i.encodeXML(a.language)},pubDate:{_text:a.pubDate?a.pubDate.toUTCString():(new Date).toUTCString()},lastBuildDate:{_text:a.lastUpdated?a.lastUpdated.toUTCString():(new Date).toUTCString()},generator:{_text:"vuepress-plugin-feed2"},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return a.copyright&&(s.rss.channel.copyright={_text:a.copyright}),a.ttl&&(s.rss.channel.ttl={_text:a.ttl.toString()}),a.image&&(s.rss.channel.image={title:{_text:a.title},url:{_text:a.image},link:{_text:i.encodeXML(a.link)}}),s.rss.channel.category=Array.from(t.categories).map((t=>({_text:t}))),s.rss.channel.item=t.items.map((t=>{const a={title:{_text:i.encodeXML(t.title)},link:{_text:i.encodeXML(t.link)},guid:m(t),source:{_attributes:{url:e.rss},_text:t.title}};if(t.description&&(a.description={_text:t.description.startsWith("html:")?i.stripTags(t.description.substring(5)):t.description}),t.author){const e=t.author.find((t=>t.email&&t.name));e&&(a.author={_text:`${e.email} (${e.name})`})}var n;return t.category&&(a.category=t.category.filter((t=>t.name)).map((t=>(t=>{const{name:e,domain:i}=t;return{_text:e,...i?{_attributes:{domain:i}}:{}}})(t)))),t.comments&&(a.comments={_text:i.encodeXML(t.link)}),t.pubDate&&(a.pubDate={_text:t.pubDate.toUTCString()}),t.content&&(r=!0,a["content:encoded"]={_cdata:i.encodeCDATA(t.content)}),t.enclosure&&(a.enclosure={_attributes:{url:(n=t.enclosure).url,...n.length?{length:n.length}:{},...n.type?{type:n.type}:{}}}),a})),r&&(s.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",s.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),n.js2xml(s,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.json=()=>(t=>{const{channel:e,links:a}=t.options,n={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:a.json};return e.description&&(n.description=e.description),e.image&&(n.icon=e.image),e.icon&&(n.favicon=e.icon),e.author?.name&&(n.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avatar?{avatar:e.author.avatar}:{}}),n.items=t.items.map((t=>{const e={title:t.title,url:t.link,id:t.guid||t.link,...t.description?{summary:t.description.startsWith("html:")?i.stripTags(t.description.substring(5)):t.description}:{},content_html:t.content};return t.image&&(e.image=t.image),t.pubDate&&(e.date_published=t.pubDate.toISOString()),t.lastUpdated&&(e.date_modified=t.lastUpdated.toISOString()),Array.isArray(t.author)&&(e.authors=t.author.filter((t=>t.name)).map((t=>(t=>({name:t.name,...t.url?{url:t.url}:{},...t.avatar?{avatar:t.avatar}:{}}))(t)))),t.category&&(e.tags=t.category.filter((t=>t.name)).map((t=>t.name))),e})),JSON.stringify(n,null,2)})(this)}}class b{constructor(t,e,i,a){this.app=t,this.options=e,this.page=i,this.feed=a,this.base=this.app.options.base,this.frontmatter=i.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return"function"==typeof this.getter.title?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return"function"==typeof this.getter.link?this.getter.link(this.page):p(this.options.hostname,this.base,this.page.path)}get description(){return"function"==typeof this.getter.description?this.getter.description(this.page):this.pageFeedOptions.description?this.pageFeedOptions.description:this.frontmatter.description?this.frontmatter.description:this.page.excerpt?`html:${o(this.app.markdown.render(this.page.excerpt),this.options.customElements)}`:null}get author(){return"function"==typeof this.getter.author?this.getter.author(this.page):Array.isArray(this.pageFeedOptions.author)?this.pageFeedOptions.author:"object"==typeof this.pageFeedOptions.author?[this.pageFeedOptions.author]:!1===this.frontmatter.author?[]:this.frontmatter.author?i.getAuthor(this.frontmatter.author):this.options.channel?.author?i.getAuthor(this.options.channel?.author):[]}get category(){if("function"==typeof this.getter.category)return this.getter.category(this.page);if(Array.isArray(this.pageFeedOptions.category))return this.pageFeedOptions.category;if("object"==typeof this.pageFeedOptions.category)return[this.pageFeedOptions.category];const{categories:t,category:e=t}=this.frontmatter;return i.getCategory(e).map((t=>({name:t})))}get enclosure(){return"function"==typeof this.getter.enclosure?this.getter.enclosure(this.page):this.image?{url:this.image,type:u(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if("function"==typeof this.getter.publishDate)return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:i}=this.page.data.git||{};return e&&e instanceof Date?e:i?new Date(i):null}get lastUpdated(){if("function"==typeof this.getter.lastUpdateDate)return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return"function"==typeof this.getter.content?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:o(this.page.contentRendered,this.options.customElements)}get image(){if("function"==typeof this.getter.image)return this.getter.image(this.page);const{banner:t,cover:e}=this.frontmatter;if(t){if(i.isAbsoluteUrl(t))return p(this.options.hostname,this.app.options.base,t);if(i.isUrl(t))return t}if(e){if(i.isAbsoluteUrl(e))return p(this.options.hostname,this.app.options.base,e);if(i.isUrl(e))return e}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(i.isAbsoluteUrl(a[1]))return p(this.options.hostname,this.app.options.base,a[1]);if(i.isUrl(a[1]))return a[1]}return null}get contributor(){return"function"==typeof this.getter.contributor?this.getter.contributor(this.page):Array.isArray(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:"object"==typeof this.pageFeedOptions.contributor?[this.pageFeedOptions.contributor]:this.author}get copyright(){if("function"==typeof this.getter.copyright)return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t?.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:i,contributor:a,copyright:n,description:r,enclosure:s,guid:o,image:p,lastUpdated:u,link:l,pubDate:c,title:h}=this;return h||r?(e&&e.forEach((t=>this.feed.addCategory(t.name))),a&&a.forEach((t=>this.feed.addContributor(t))),{title:h,link:l,guid:o,lastUpdated:u,content:i,author:t,contributor:a,...r?{description:r}:{},...e?{category:e}:{},...s?{enclosure:s}:{},...c?{pubDate:c}:{},...p?{image:p}:{},...n?{copyright:n}:{}}):null}}class y{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map((([e,i])=>[e,new f({channel:c(t,i,e),links:d(t,i)})])))}addPages(e){const i=this.feedMap[e],a=this.options[e],{count:n=100,filter:o=(({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed)),sorter:p=((t,e)=>s(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date))}=a,u=this.app.pages.filter((t=>t.pathLocale===e)).filter(o).sort(p).slice(0,n);let l=0;for(const t of u){const e=new b(this.app,a,t,i).getFeedItem();e&&(i.addItem(e),l+=1)}r.succeed(`added ${t.chalk.cyan(`${l} page(s)`)} as feed item(s) in route ${t.chalk.cyan(e)}`)}async generateFeed(){const{dest:e}=this.app.dir;await Promise.all(Object.entries(this.options).map((async([i,n])=>{if(n.atom||n.json||n.rss){const s=this.feedMap[i],{atomOutputFilename:o,jsonOutputFilename:p,rssOutputFilename:u}=h(n,i);this.addPages(i),n.atom&&(await t.fs.ensureDir(a.dirname(e(o))),await t.fs.outputFile(e(o),s.atom()),r.succeed(`Atom feed file generated and saved to ${t.chalk.cyan(o)}`)),n.json&&(await t.fs.ensureDir(a.dirname(e(p))),await t.fs.outputFile(e(p),s.json()),r.succeed(`JSON feed file generated and saved to ${t.chalk.cyan(p)}`)),n.rss&&(await t.fs.ensureDir(a.dirname(e(u))),await t.fs.outputFile(e(u),s.rss()),r.succeed(`RSS feed file generated and saved to ${t.chalk.cyan(u)}`))}})))}}const _=(i,a=!1)=>n=>{a&&l(i),n.env.isDebug&&r.info(`Options: ${i.toString()}`);const o={name:"vuepress-plugin-feed2"};if(!(t=>!!t.hostname&&(t.hostname=e.isLinkHttp(t.hostname)?e.removeEndingSlash(t.hostname):`https://${e.removeEndingSlash(t.hostname)}`,!0))(i))return r.error(`Option ${t.chalk.magenta("hostname")} is required!`),o;if(!(t=>t.locales&&Object.entries(t.locales).some((([,{atom:t,json:e,rss:i}])=>t||e||i))||Boolean(t.atom||t.json||t.rss))(i))return r.info("No requested output, the plugin won’t start!"),o;const u=(({siteData:t},e)=>Object.fromEntries(Object.keys({"/":{},...t.locales}).map((t=>[t,{filter:({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed),sorter:(t,e)=>s(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date),...e,...e.locales?.[t],hostname:e.hostname}]))))(n,i);return{...o,onPrepared:t=>((t,e)=>{const{base:i}=t.options,{siteData:a}=t,n=Object.keys(e);if(1===n.length){const{atomOutputFilename:t,jsonOutputFilename:n,rssOutputFilename:r}=h(e["/"]),{atom:s,json:o,rss:u,hostname:l}=e["/"],c=(t,e,n)=>["link",{rel:"alternate",type:n,href:p(l,i,e),title:`${a.title||a.locales["/"]?.title||""} ${t} Feed`}];a.head||(a.head=[]),s&&a.head.push(c("Atom",t,"application/atom+xml")),o&&a.head.push(c("JSON",n,"application/json")),u&&a.head.push(c("RSS",r,"application/rss+xml"))}else t.pages.forEach((t=>{const{pathLocale:r}=t,s=e[r];if(n.includes(r)){const{atomOutputFilename:e,jsonOutputFilename:n,rssOutputFilename:o}=h(s,r),u=(t,e,n)=>["link",{rel:"alternate",type:n,href:p(s.hostname,i,e),title:`${a.locales[r]?.title||a.title||a.locales["/"]?.title||""} ${t} Feed`}];t.frontmatter.head||(t.frontmatter.head=[]),s.atom&&t.frontmatter.head.push(u("Atom",e,"application/atom+xml")),s.json&&t.frontmatter.head.push(u("JSON",n,"application/json")),s.rss&&t.frontmatter.head.push(u("RSS",o,"application/rss+xml"))}}))})(t,u),onGenerated:async t=>{await new y(t,u).generateFeed()}}};exports.default=_,exports.feedPlugin=_;
//# sourceMappingURL=index.js.map
